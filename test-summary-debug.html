<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Summary Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success { color: green; }
        .error { color: red; }
        .loading { color: orange; }
        .debug { background: #f0f0f0; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .logs { background: #333; color: #fff; padding: 10px; border-radius: 4px; max-height: 400px; overflow-y: auto; font-family: monospace; }
        input, textarea, button { margin: 5px; padding: 8px; }
        .flex { display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>
    <h1>üß™ Test Summary Debug</h1>

    <div class="test-panel">
        <h2>üìã API Configuration</h2>
        <div>
            <h3>OpenAI API Key</h3>
            <div class="flex">
                <input type="password" id="openaiApiKey" placeholder="Enter OpenAI API Key" style="width: 300px;">
                <button onclick="testOpenAIKey()">Test OpenAI</button>
            </div>
            <div id="openaiStatus"></div>
        </div>

        <div style="margin-top: 20px;">
            <h3>Gemini API Key</h3>
            <div class="flex">
                <input type="password" id="geminiApiKey" placeholder="Enter Gemini API Key" style="width: 300px;">
                <button onclick="testGeminiKey()">Test Gemini</button>
            </div>
            <div id="geminiStatus"></div>
        </div>

        <div style="margin-top: 20px;">
            <h3>Preferred Provider</h3>
            <select id="preferredProvider">
                <option value="openai">OpenAI (GPT)</option>
                <option value="gemini">Google Gemini</option>
            </select>
        </div>
    </div>

    <div class="test-panel">
        <h2>üéØ AI Summary Test</h2>
        <div class="flex">
            <button onclick="testSummaryGeneration()">Generate Summary</button>
            <button onclick="testSummaryWithFallback()">Test with Fallback</button>
        </div>
        <div id="summaryStatus"></div>
        <div id="summaryResult"></div>
    </div>

    <div class="test-panel">
        <h2>üìù Debug Logs</h2>
        <button onclick="clearLogs()">Clear Logs</button>
        <div id="logs" class="logs"></div>
    </div>

    <script>
        // Mock chrome APIs
        window.chrome = {
            runtime: {
                sendMessage: async (message) => {
                    log(`üì§ Sending message: ${message.action}`);

                    if (message.action === 'requestTicketSummary') {
                        return await mockSummaryRequest(message.data);
                    }

                    return { success: false, error: 'Unknown action' };
                },
                getURL: (path) => `./${path}`
            },
            storage: {
                sync: {
                    get: async (keys) => {
                        log(`üì§ Storage get: ${JSON.stringify(keys)}`);
                        const openaiKey = document.getElementById('openaiApiKey').value;
                        const geminiKey = document.getElementById('geminiApiKey').value;
                        const preferredProvider = document.getElementById('preferredProvider').value;

                        const result = {};

                        if (openaiKey) {
                            result.encryptedApiKey = btoa(openaiKey);
                        }
                        if (geminiKey) {
                            result.encryptedGeminiApiKey = btoa(geminiKey);
                        }

                        result.userRole = 'developer';
                        result.language = 'vi';
                        result.aiModel = 'gpt-3.5-turbo';
                        result.preferredProvider = preferredProvider;

                        return result;
                    },
                    set: async (data) => {
                        log(`üì§ Storage set: ${JSON.stringify(Object.keys(data))}`);
                        return true;
                    }
                }
            }
        };

        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testOpenAIKey() {
            const apiKey = document.getElementById('openaiApiKey').value;
            const status = document.getElementById('openaiStatus');

            if (!apiKey) {
                status.innerHTML = '<p class="error">‚ùå Please enter OpenAI API key</p>';
                return;
            }

            status.innerHTML = '<p class="loading">‚è≥ Testing OpenAI API key...</p>';
            log(`üîë Testing OpenAI API key: ${apiKey.substring(0, 8)}...`);

            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (response.ok) {
                    status.innerHTML = '<p class="success">‚úÖ OpenAI API key is valid</p>';
                    log('‚úÖ OpenAI API key validation successful');
                } else {
                    const errorText = await response.text();
                    status.innerHTML = `<p class="error">‚ùå OpenAI API key invalid: ${response.status}</p>`;
                    log(`‚ùå OpenAI API key validation failed: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                status.innerHTML = `<p class="error">‚ùå Error testing OpenAI API key: ${error.message}</p>`;
                log(`‚ùå OpenAI API key test error: ${error.message}`);
            }
        }

        async function testGeminiKey() {
            const apiKey = document.getElementById('geminiApiKey').value;
            const status = document.getElementById('geminiStatus');

            if (!apiKey) {
                status.innerHTML = '<p class="error">‚ùå Please enter Gemini API key</p>';
                return;
            }

            status.innerHTML = '<p class="loading">‚è≥ Testing Gemini API key...</p>';
            log(`üîë Testing Gemini API key: ${apiKey.substring(0, 8)}...`);

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: "Test connection"
                            }]
                        }]
                    })
                });

                if (response.ok) {
                    status.innerHTML = '<p class="success">‚úÖ Gemini API key is valid</p>';
                    log('‚úÖ Gemini API key validation successful');
                } else {
                    const errorText = await response.text();
                    status.innerHTML = `<p class="error">‚ùå Gemini API key invalid: ${response.status}</p>`;
                    log(`‚ùå Gemini API key validation failed: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                status.innerHTML = `<p class="error">‚ùå Error testing Gemini API key: ${error.message}</p>`;
                log(`‚ùå Gemini API key test error: ${error.message}`);
            }
        }

        async function testApiKey() {
            // Test both keys
            await testOpenAIKey();
            await testGeminiKey();
        }

        async function testSummaryGeneration() {
            const status = document.getElementById('summaryStatus');
            const result = document.getElementById('summaryResult');

            status.innerHTML = '<p class="loading">‚è≥ Generating summary...</p>';
            result.innerHTML = '';

            const mockTicketData = {
                id: 'TEST-001',
                title: 'Bug trong ch·ª©c nƒÉng ƒëƒÉng nh·∫≠p',
                description: 'Ng∆∞·ªùi d√πng kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng khi s·ª≠ d·ª•ng email c√≥ k√Ω t·ª± ƒë·∫∑c bi·ªát.',
                status: 'Open',
                priority: 'High',
                assignee: 'John Doe',
                reporter: 'Jane Smith',
                dueDate: '2025-02-01',
                labels: ['bug', 'authentication', 'urgent']
            };

            log('üéØ Starting summary generation...');
            log(`üìù Mock ticket: ${mockTicketData.id} - ${mockTicketData.title}`);

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'requestTicketSummary',
                    data: {
                        ticketId: mockTicketData.id,
                        ticketData: mockTicketData
                    }
                });

                log(`üì• Summary response: ${JSON.stringify(response)}`);

                if (response.success) {
                    status.innerHTML = '<p class="success">‚úÖ Summary generated successfully</p>';
                    result.innerHTML = `<div class="debug"><strong>Summary:</strong><br>${response.summary}</div>`;
                } else {
                    status.innerHTML = `<p class="error">‚ùå Summary generation failed: ${response.error}</p>`;
                    result.innerHTML = `<div class="debug"><strong>Error:</strong><br>${response.error}</div>`;
                }
            } catch (error) {
                status.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
                log(`‚ùå Summary generation error: ${error.message}`);
            }
        }

        async function testSummaryWithFallback() {
            const status = document.getElementById('summaryStatus');
            const result = document.getElementById('summaryResult');

            status.innerHTML = '<p class="loading">‚è≥ Testing summary with fallback...</p>';
            result.innerHTML = '';

            const mockTicketData = {
                id: 'TEST-001',
                title: 'Bug trong ch·ª©c nƒÉng ƒëƒÉng nh·∫≠p',
                description: 'Ng∆∞·ªùi d√πng kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng khi s·ª≠ d·ª•ng email c√≥ k√Ω t·ª± ƒë·∫∑c bi·ªát.',
                status: 'Open',
                priority: 'High',
                assignee: 'John Doe',
                reporter: 'Jane Smith',
                dueDate: '2025-02-01',
                labels: ['bug', 'authentication', 'urgent']
            };

            log('üéØ Starting summary generation with fallback test...');

            // First try with invalid OpenAI key to test fallback
            document.getElementById('openaiApiKey').value = 'invalid-key';

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'requestTicketSummary',
                    data: {
                        ticketId: mockTicketData.id,
                        ticketData: mockTicketData
                    }
                });

                log(`üì• Summary response: ${JSON.stringify(response)}`);

                if (response.success) {
                    status.innerHTML = '<p class="success">‚úÖ Summary generated with fallback</p>';
                    result.innerHTML = `<div class="debug"><strong>Summary:</strong><br>${response.summary}</div>`;
                } else {
                    status.innerHTML = `<p class="error">‚ùå Summary generation failed: ${response.error}</p>`;
                    result.innerHTML = `<div class="debug"><strong>Error:</strong><br>${response.error}</div>`;
                }
            } catch (error) {
                status.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
                log(`‚ùå Summary generation error: ${error.message}`);
            }
        }
            const status = document.getElementById('summaryStatus');
            const result = document.getElementById('summaryResult');

            status.innerHTML = '<p class="loading">‚è≥ Generating summary...</p>';
            result.innerHTML = '';

            const mockTicketData = {
                id: 'TEST-001',
                title: 'Bug trong ch·ª©c nƒÉng ƒëƒÉng nh·∫≠p',
                description: 'Ng∆∞·ªùi d√πng kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng khi s·ª≠ d·ª•ng email c√≥ k√Ω t·ª± ƒë·∫∑c bi·ªát.',
                status: 'Open',
                priority: 'High',
                assignee: 'John Doe',
                reporter: 'Jane Smith',
                dueDate: '2025-02-01',
                labels: ['bug', 'authentication', 'urgent'],
                comments: [
                    {
                        author: 'Jane Smith',
                        content: 'L·ªói x·∫£y ra khi email ch·ª©a k√Ω t·ª± + ho·∫∑c .',
                        timestamp: '2025-01-28T10:00:00Z'
                    }
                ]
            };

            log('üéØ Starting mock summary generation...');
            log(`üìù Mock ticket: ${mockTicketData.id} - ${mockTicketData.title}`);

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'requestTicketSummary',
                    data: {
                        ticketId: mockTicketData.id,
                        ticketData: mockTicketData
                    }
                });

                log(`üì• Summary response: ${JSON.stringify(response)}`);

                if (response.success) {
                    status.innerHTML = '<p class="success">‚úÖ Summary generated successfully</p>';
                    result.innerHTML = `<div class="debug"><strong>Summary:</strong><br>${response.summary}</div>`;
                } else {
                    status.innerHTML = `<p class="error">‚ùå Summary generation failed: ${response.error}</p>`;
                    result.innerHTML = `<div class="debug"><strong>Error:</strong><br>${response.error}</div>`;
                }
            } catch (error) {
                status.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
                log(`‚ùå Summary generation error: ${error.message}`);
            }
        }

        async function testSummaryWithFallback() {
            const status = document.getElementById('summaryStatus');
            const result = document.getElementById('summaryResult');

            status.innerHTML = '<p class="loading">‚è≥ Testing summary with fallback...</p>';
            result.innerHTML = '';

            const mockTicketData = {
                id: 'TEST-FALLBACK',
                title: 'Test fallback mechanism',
                description: 'Testing if system can fallback from OpenAI to Gemini when quota exceeded',
                status: 'Testing',
                priority: 'High'
            };

            log('üéØ Starting summary generation with fallback test...');

            // Temporarily set invalid OpenAI key to test fallback
            const originalOpenAI = document.getElementById('openaiApiKey').value;
            document.getElementById('openaiApiKey').value = 'sk-invalid-key-to-test-fallback';

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'requestTicketSummary',
                    data: {
                        ticketId: mockTicketData.id,
                        ticketData: mockTicketData
                    }
                });

                log(`üì• Fallback test response: ${JSON.stringify(response)}`);

                if (response.success) {
                    status.innerHTML = '<p class="success">‚úÖ Summary generated with fallback mechanism</p>';
                    result.innerHTML = `<div class="debug"><strong>Fallback Summary:</strong><br>${response.summary}</div>`;
                } else {
                    status.innerHTML = `<p class="error">‚ùå Fallback test failed: ${response.error}</p>`;
                    result.innerHTML = `<div class="debug"><strong>Error:</strong><br>${response.error}</div>`;
                }
            } catch (error) {
                status.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
                log(`‚ùå Fallback test error: ${error.message}`);
            } finally {
                // Restore original OpenAI key
                document.getElementById('openaiApiKey').value = originalOpenAI;
            }
        }

        async function mockSummaryRequest(data) {
            log('üîÑ Mock summary request processing...');

            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                log('‚ùå No API key provided');
                return { success: false, error: 'API key ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh' };
            }

            log(`üîß Using API key: ${apiKey.substring(0, 8)}...`);
            log(`üìù Ticket data: ${JSON.stringify(data.ticketData, null, 2)}`);

            // Mock the summary prompt building
            const prompt = `H√£y t·∫°o t√≥m t·∫Øt cho ticket sau:
ID: ${data.ticketData.id}
Title: ${data.ticketData.title}
Description: ${data.ticketData.description}
Status: ${data.ticketData.status}
Priority: ${data.ticketData.priority}`;

            log(`üìù Generated prompt (${prompt.length} chars)`);

            try {
                log('üîÑ Calling OpenAI API...');
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'B·∫°n l√† m·ªôt AI assistant gi√∫p summarize ticket m·ªôt c√°ch ch√≠nh x√°c v√† h·ªØu √≠ch.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.3
                    })
                });

                log(`üîß Response status: ${response.status}`);
                log(`üîß Response ok: ${response.ok}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå API Error Response: ${errorText}`);
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }

                const responseData = await response.json();
                log(`üîß API Response structure: ${JSON.stringify({
                    hasChoices: !!responseData.choices,
                    choicesLength: responseData.choices?.length,
                    hasError: !!responseData.error
                })}`);

                if (responseData.error) {
                    throw new Error(`OpenAI API Error: ${responseData.error.message}`);
                }

                if (responseData.choices && responseData.choices[0] && responseData.choices[0].message && responseData.choices[0].message.content) {
                    const summary = responseData.choices[0].message.content;
                    log(`‚úÖ Summary generated successfully (${summary.length} chars)`);
                    return { success: true, summary };
                } else {
                    log('‚ùå Invalid API response structure');
                    throw new Error('Invalid API response - no content in choices');
                }
            } catch (error) {
                log(`‚ùå Error calling OpenAI API: ${error.message}`);
                return { success: false, error: `L·ªói khi g·ªçi AI API: ${error.message}` };
            }
        }

        // Auto-focus on first API key input
        window.addEventListener('load', () => {
            document.getElementById('openaiApiKey').focus();
            log('üöÄ Multi-AI summary debug test page loaded');
            log('üí° Configure API keys and test the AI integration with fallback support');
        });
    </script>
</body>
</html>
